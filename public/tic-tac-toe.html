<!-- File: public/tic-tac-toe.html
     Title: Tic Tac Toe - Drinking Mini Games
     Description: Implements a Tic Tac Toe game where each move fills the cell with the player's chosen color and symbol (X or O).
                  The current player's name is displayed at the top in an oval with a 300% larger font in their color.
                  When a win occurs, a custom modal popup shows "Player <winning name> won! Player <losing name> drinks <n> times."
                  When the game is a draw, the modal displays "It's a draw!" with "Home" and "Play Again" buttons.
                  A back button at the bottom returns to the Game Home Screen.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tic Tac Toe - Drinking Mini Games</title>
  <link rel="stylesheet" href="../assets/css/styles.css">
  <style>
    /* Tic Tac Toe specific styles */
    #tic-tac-toe-container {
      max-width: 400px;
      margin: 20px auto;
    }
    /* Current player display styling */
    #current-player-display {
      margin: 10px auto;
      width: fit-content;
      padding: 10px 20px;
      border-radius: 50px;
      font-size: 3em; /* 300% larger font */
      color: #fff;
      font-weight: bold;
    }
    .board {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 5px;
    }
    .cell {
      background: #fff;
      border: 2px solid #333;
      font-size: 2em;
      font-weight: bold;
      height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #fff; /* Ensure the symbol is visible */
    }
    .cell.disabled {
      pointer-events: none;
      opacity: 0.8;
    }
    #status {
      margin: 15px 0;
      font-size: 1.2em;
    }
    #back-button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 1em;
      background-color: #ccc;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #back-button:hover {
      background-color: #b3b3b3;
    }
    /* Modal styling */
    #win-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 2px solid #333;
      padding: 20px;
      z-index: 1000;
      text-align: center;
    }
    #win-modal p {
      font-size: 1.2em;
      margin-bottom: 20px;
    }
    #win-modal button {
      padding: 10px 20px;
      margin: 0 10px;
      font-size: 1em;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #win-modal button:hover {
      opacity: 0.8;
    }
    /* Modal overlay styling */
    #modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 900;
    }
  </style>
</head>
<body>
  <header>
    <h1>Tic Tac Toe</h1>
  </header>
  
  <!-- Current Player Display -->
  <div id="current-player-display"></div>
  
  <!-- Main Game Container -->
  <main id="tic-tac-toe-container">
    <div id="status">Loading game...</div>
    <div class="board" id="board">
      <div class="cell" data-index="0"></div>
      <div class="cell" data-index="1"></div>
      <div class="cell" data-index="2"></div>
      <div class="cell" data-index="3"></div>
      <div class="cell" data-index="4"></div>
      <div class="cell" data-index="5"></div>
      <div class="cell" data-index="6"></div>
      <div class="cell" data-index="7"></div>
      <div class="cell" data-index="8"></div>
    </div>
    <button id="back-button" onclick="window.location.href='game-home.html'">Back to Game Home</button>
  </main>
  
  <div id="modal-overlay"></div>
  
  <!-- Win/Draw Modal Popup -->
  <div id="win-modal">
    <p id="win-message"></p>
    <button onclick="goToHome()">Home</button>
    <button onclick="playAgain()">Play Again</button>
  </div>
  
  <script>
    // Retrieve player details from localStorage and ensure each has a score property
    let players = JSON.parse(localStorage.getItem("playerDetails") || "[]").map(p => {
      if (p.score === undefined) p.score = 0;
      return p;
    });
    // In one-player mode, if only one player exists, add a default AI player.
    if (players.length < 2) {
      players.push({ name: "AI", color: "gray", drink: "Beer", score: 0 });
    }
    // Define player symbols: Player 1 = X, Player 2 = O
    const symbols = ["X", "O"];
    const playerCount = parseInt(localStorage.getItem("playerCount"), 10) || 2;
    const isOnePlayer = (playerCount === 1);
    
    let currentPlayerIndex = 0;
    let board = Array(9).fill(null);
    let gameActive = true;
    
    const statusDiv = document.getElementById("status");
    const cells = document.querySelectorAll(".cell");
    const currentPlayerDisplay = document.getElementById("current-player-display");
    
    const winningCombos = [
      [0, 1, 2],
      [3, 4, 5],
      [6, 7, 8],
      [0, 3, 6],
      [1, 4, 7],
      [2, 5, 8],
      [0, 4, 8],
      [2, 4, 6]
    ];
    
    function updateStatus(message) {
      statusDiv.textContent = message;
    }
    
    function updateCurrentPlayerDisplay() {
      currentPlayerDisplay.textContent = players[currentPlayerIndex].name;
      currentPlayerDisplay.style.backgroundColor = players[currentPlayerIndex].color;
    }
    
    function checkGameOver() {
      for (let combo of winningCombos) {
        const [a, b, c] = combo;
        if (board[a] !== null && board[a] === board[b] && board[a] === board[c]) {
          return board[a];
        }
      }
      if (board.every(cell => cell !== null)) return "draw";
      return null;
    }
    
    function showWinModal(winningPlayer, losingPlayer, drinks) {
      const winModal = document.getElementById("win-modal");
      const modalOverlay = document.getElementById("modal-overlay");
      const winMessage = document.getElementById("win-message");
      winMessage.textContent = "Player " + players[winningPlayer].name + " won! Player " +
                                 players[losingPlayer].name + " drinks " + drinks + " times.";
      winModal.style.display = "block";
      modalOverlay.style.display = "block";
    }
    
    function showDrawModal() {
      const winModal = document.getElementById("win-modal");
      const modalOverlay = document.getElementById("modal-overlay");
      const winMessage = document.getElementById("win-message");
      winMessage.textContent = "It's a draw!";
      winModal.style.display = "block";
      modalOverlay.style.display = "block";
    }
    
    function handleCellClick(e) {
      const index = e.target.getAttribute("data-index");
      if (!gameActive || board[index] !== null) return;
      
      board[index] = currentPlayerIndex;
      e.target.style.backgroundColor = players[currentPlayerIndex].color;
      e.target.textContent = symbols[currentPlayerIndex];
      e.target.classList.add("disabled");
      
      const result = checkGameOver();
      if (result !== null) {
        if (result === "draw") {
          updateStatus("It's a draw!");
          showDrawModal();
        } else {
          const winningPlayer = result;
          const losingPlayer = (winningPlayer === 0) ? 1 : 0;
          const drinks = (players[losingPlayer].drink === "Beer") ? 2 : 1;
          players[losingPlayer].score += drinks;
          players[winningPlayer].wins = (players[winningPlayer].wins || 0) + 1;
          localStorage.setItem("playerDetails", JSON.stringify(players));
          updateStatus(players[winningPlayer].name + " wins!");
          showWinModal(winningPlayer, losingPlayer, drinks);
        }
        gameActive = false;
        return;
      }
      
      currentPlayerIndex = (currentPlayerIndex === 0) ? 1 : 0;
      updateStatus(players[currentPlayerIndex].name + "'s turn");
      updateCurrentPlayerDisplay();
      
      if (isOnePlayer && currentPlayerIndex === 1) {
        setTimeout(aiMove, 500);
      }
    }
    
    function aiMove() {
      const emptyIndices = board.map((val, idx) => val === null ? idx : null).filter(val => val !== null);
      if (emptyIndices.length === 0) return;
      const randomIndex = emptyIndices[Math.floor(Math.random() * emptyIndices.length)];
      const cell = document.querySelector(`.cell[data-index="${randomIndex}"]`);
      board[randomIndex] = 1;
      cell.style.backgroundColor = players[1].color;
      cell.textContent = symbols[1];
      cell.classList.add("disabled");
      
      const result = checkGameOver();
      if (result !== null) {
        if (result === "draw") {
          updateStatus("It's a draw!");
          showDrawModal();
        } else {
          const winningPlayer = result;
          const losingPlayer = (winningPlayer === 0) ? 1 : 0;
          const drinks = (players[losingPlayer].drink === "Beer") ? 2 : 1;
          players[losingPlayer].score += drinks;
          players[winningPlayer].wins = (players[winningPlayer].wins || 0) + 1;
          localStorage.setItem("playerDetails", JSON.stringify(players));
          updateStatus(players[winningPlayer].name + " wins!");
          showWinModal(winningPlayer, losingPlayer, drinks);
        }
        gameActive = false;
        return;
      }
      
      currentPlayerIndex = 0;
      updateStatus(players[currentPlayerIndex].name + "'s turn");
      updateCurrentPlayerDisplay();
    }
    
    cells.forEach(cell => {
      cell.addEventListener("click", handleCellClick);
    });
    
    updateStatus(players[currentPlayerIndex].name + "'s turn" + (isOnePlayer ? " (You are Player 1)" : ""));
    updateCurrentPlayerDisplay();
  </script>
  
  <script>
    function goToHome() {
      window.location.href = "game-home.html";
    }
    function playAgain() {
      window.location.reload();
    }
  </script>
</body>
</html>
